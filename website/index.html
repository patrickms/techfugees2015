<html>
<head>

<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
<style>
  .table-row {
    border-style: groove;
    width:100%;
  }
  
  .main-table {
    width:100%;
    border-style: double;
  }
  
  .map-div{
    width:100%;
    height:100pt;
  }
</style>
<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="http://www.openlayers.org/api/OpenLayers.js"></script>
<script>
  var firebaseRoot = new Firebase("https://techfugees2015.firebaseio.com/");
  var allQuestions = firebaseRoot.child("allQuestions");
  allQuestions.on("value", function(data){updateGrid(data.val())});
  
  var tableRowPrototype='<div class="table-row">\n'+
    '<div class = "pure-u-1-4">\n'+
      'Answer:  <div onclick="answerEnglish(\'$ID\', \'$USER\', \'$NATIVE_LANG\')" class = "pure-button">en</div> &nbsp;\n'+
      '<div onclick="answerNative(\'$ID\', \'$USER\', \'$NATIVE_LANG\')" class = "pure-button">$NATIVE_LANG</div><br>\n'+
    '</div>\n'+
    '<div class = "pure-u-1-2">\n'+
      '$ENGLISH_QUESTION<br>\n'+
      '$NATIVE_QUESTION<br>\n'+
      '$ENGLISH_ANSWER<br>\n'+
      '$NATIVE_ANSWER\n'+
    '</div>\n'+
    '<div id = "mapdiv$MAPDIVID" class = "pure-u-1-4 map-div">\n'+
    '</div>\n'+
  '</div>\n';
  
  function answerEnglish(id, user, lang)
  {
    response=window.prompt("What is your answer in English","")
    if(response && response.length>0)
      allQuestions.child(id).child("englishanswer").set(response);
  }
  function answerNative(id, user, lang)
  {
    response=window.prompt("What is your answer in "+getLanguageName(lang),"")
    if(response && response.length>0)
      allQuestions.child(id).child("nativeanswer").set(response);
  }
  
  function getSpeechLanguage(lang)
  {
  var speechLanguages={ "en":"en-US", "es":"es-US", "zh":"zh-CN", "ar":"ar-AE" };
  	return speechLanguages[lang];
  }
  function getTranslationLanguage(lang)
  {
    var translateLanguages={ "en":"en", "es":"es", "zh":"zh-CHS", "ar":"ar" };
  	return translateLanguages[lang];
  }
  function getLanguageName(lang)
  {
    var languageNames={ "en":"English", "es":"español", "zh":"中文", "ar":"العربية" };
  	return languageNames[lang];
  }
  
  function loadMap(mapcounter, lon, lat)
  {
    var map = new OpenLayers.Map("mapdiv"+mapcounter);
    map.addLayer(new OpenLayers.Layer.OSM());
 
    var lonLat = new OpenLayers.LonLat( lon, lat )
          .transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            map.getProjectionObject() // to Spherical Mercator Projection
          );
 
    var zoom=16;
 
    var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);
 
    markers.addMarker(new OpenLayers.Marker(lonLat));
 
    map.setCenter (lonLat, zoom);
  }
  
  function updateGrid(data)
  {
    var keys = [];
    var k, i, len;
  
    for (k in data) {
      if (data.hasOwnProperty(k)) {
        keys.push(k);
      }
    }
    
    function descending(x, y)
    {
      if(x<y)
        return 1;
      else if(x>y)
        return -1;
      else
        return 0;
    }
    
    keys.sort(descending);
    
    len = keys.length;
    
    var html = ""
    var mapcounter=1;
    for (i = 0; i < len; i++) {
      k = keys[i];
      row=data[k];
      rowHTML=tableRowPrototype;
      rowHTML=rowHTML.replace(/\$ID/g,k);
      rowHTML=rowHTML.replace(/\$USER/g,row.user);
      rowHTML=rowHTML.replace(/\$ENGLISH_QUESTION/g,row.englishquestion || "<No English question>");
      rowHTML=rowHTML.replace(/\$NATIVE_QUESTION/g,row.nativequestion || "<No native language question>");
      rowHTML=rowHTML.replace(/\$ENGLISH_ANSWER/g,row.englishanswer ||"<No English answer>");
      rowHTML=rowHTML.replace(/\$NATIVE_ANSWER/g,row.nativeanswer ||"<No native language answer>");
      rowHTML=rowHTML.replace(/\$NATIVE_LANG/g,row.nativelanguage ||"<Language unknown>");
      rowHTML=rowHTML.replace(/\$MAPDIVID/g,mapcounter);
      html+=rowHTML;
      
      if(row.position && row.position.coords)
      {
        html+="<script>\nloadMap("+mapcounter+","row.position.coords.longitude+","+row.positions.coords.latitude+");\n</script>\n"; 
      }
      mapcounter++
    }
    $(".main-table").html(html);
  }
</script>
</head>
<body>
  <div class="pure-menu pure-menu-horizontal" style="height:10%;width:100%;background-color:coral;text-align:center">
    <span style="font-size:200%">Help out by answering questions</span>
    <!--
    <ul class="pure-menu-list">
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">News</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">Sports</a></li>
        <li class="pure-menu-item"><a href="#" class="pure-menu-link">Finance</a></li>
    </ul>-->
</div>
<div class="pure-g main-table">
</div>
</body>
</html>
